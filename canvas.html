<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Color canvas</title>
  <style>
  #canvas {
    border-radius: 50%;
  }
  </style>
</head>
<body>
  <h1>Color canvas</h1>
  <div id="loadingAnimation">loading</div>
  <canvas id="canvas"></canvas>


  <script>
    /** @type {HTMLCanvasElement} */
    const canvas = document.getElementById('canvas')
    /** @type {CanvasRenderingContext2D} */
    const ctx = canvas.getContext('2d')

    /**
     * Luminance is set to 0.5
     * @param h - hue, a number between [0, 6)
     * @param s - saturation, a number between [0, 1)
     */
    function _hsToRgb(h, s) {
      const X = s * (1 - Math.abs(h % 2 - 1))
      let r = g = b = 0

      if      (h >= 0 && h < 1) { r = s; g = X }
      else if (h >= 1 && h < 2) { r = X; g = s }
      else if (h >= 2 && h < 3) { g = s; b = X }
      else if (h >= 3 && h < 4) { g = X; b = s }
      else if (h >= 4 && h < 5) { r = X; b = s }
      else                      { r = s; b = X }

      const m = (1 - s) / 2
      r = Math.floor((r + m) * 255)
      g = Math.floor((g + m) * 255)
      b = Math.floor((b + m) * 255)
      return [r, g, b];
    }

    function draw(size, onFinished) {
      canvas.width = canvas.height = size
      canvas.style.width = canvas.style.height = size + 'px'

      let radius = size / 2
      let img = ctx.getImageData(0, 0, size, size)
      let data = img.data

      let nextRowToPaint = 0

      function drawRow() {
        const y = nextRowToPaint
        nextRowToPaint++

        const rowOffset = y * size

        for (let x = 0; x < size; x++) {
          const offset = (rowOffset + x) << 2
          const rX = radius - x
          const rY = radius - y

          const dx = rX / radius
          const dy = rY / radius
          const fromCenter = Math.sqrt(dx * dx + dy * dy)

          const hue = Math.atan2(rY, rX) / Math.PI * 3 + 3

          const rgb = _hsToRgb(hue, fromCenter)

          data[offset    ] = rgb[0]
          data[offset + 1] = rgb[1]
          data[offset + 2] = rgb[2]
          data[offset + 3] = 255
        }
      }

      for (let y = 0; y < size; y++) setTimeout(drawRow)
      setTimeout(function() {
        ctx.putImageData(img, 0, 0)
        if (onFinished) onFinished()
      })
    }

    const $loadingAnimation = document.getElementById('loadingAnimation')
    let loaded = false

    requestAnimationFrame(function loadingAnimation() {
      $loadingAnimation.textContent += '.'
      if (!loaded) requestAnimationFrame(loadingAnimation)
      else $loadingAnimation.style.visibility = 'hidden'
    })

    const then = performance.now()
    draw(330, () => {
      loaded = true
      const elapsed = performance.now() - then
      console.log(`Elapsed: ${elapsed.toFixed(2)} ms`)
    })

  </script>
</body>
</html>